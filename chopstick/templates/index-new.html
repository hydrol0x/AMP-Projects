<!doctype html>
<html>
    <head>
        <title>{{ title }}</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                min-height: 100vh;
                padding: 20px;
                box-sizing: border-box;
            }
            h1, h2, h3, h4 {
                color: #2c3e50;
                font-weight: bold;
                margin-bottom: 10px;
            }
            hr {
                border: none;
                border-top: 1px solid black;
                margin: 20px 0;
                width: 100%;
                max-width: 600px;
            }
            button {
                transition: all 0.2s ease-in-out;
            }
            button:hover {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            }
            .player-card {
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                padding: 20px;
                margin-bottom: 15px;
                width: 100%;
                max-width: 300px;
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
            }
            .player-card h4 {
                font-size: 1.25rem;
                margin-bottom: 10px;
            }
            .player-card p {
                font-size: 1rem;
            }
            .hint-box {
                border: 1px solid blue;
                padding: 15px;
                margin: 20px 0;
                background-color: #e0f2ff;
                border-radius: 8px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
                width: 100%;
                max-width: 600px;
            }
            .hint-box h4 {
                color: #0066cc;
                margin-bottom: 8px;
            }
            .hint-box p {
                font-size: 0.95rem;
                line-height: 1.4;
            }
            .game-info-section {
                background-color: white;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
                padding: 25px;
                width: 100%;
                max-width: 600px;
                margin-bottom: 20px;
            }
	    img {
                 height:150px;
                 width:150px;
	     }
            .game-info-section h3 {
                font-size: 1.5rem;
                margin-bottom: 15px;
                text-align: center;
            }
            .game-info-section button {
                width: 100%;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                margin-top: 10px;
            }
            .game-info-section button:first-of-type {
                margin-top: 0;
            }
            .move-button {
                background-color: #4a90e2;
                color: white;
                padding: 10px 15px;
                border-radius: 6px;
                margin-bottom: 8px;
                font-size: 0.9rem;
                text-align: left;
                width: 100%;
                border: none;
                cursor: pointer;
            }
            .move-button:hover {
                background-color: #357abd;
            }
            .control-button {
                background-color: #28a745;
                color: white;
                border: none;
                cursor: pointer;
                padding: 12px 25px;
                border-radius: 8px;
                font-size: 1rem;
                font-weight: 600;
                margin: 5px;
            }
            .control-button.reset {
                background-color: #dc3545;
            }
            .control-button.hint {
                background-color: #17a2b8;
            }
            .control-button:hover {
                opacity: 0.9;
            }
        </style>
        <script>
            let gameId = "{{ game_id }}";

            function updateGameDisplay(data) {
                const currentPlayerDiv = document.getElementById('current-player');
                if (data.winner !== null) {
                    currentPlayerDiv.innerHTML = `<h2 class="text-3xl font-bold text-center text-green-700 mb-4">Game Over, Player ${data.winner + 1} Wins!</h2>`;
                } else {
                    currentPlayerDiv.innerHTML = `<h2 class="text-2xl font-semibold text-center text-blue-600 mb-4">Current Turn: Player ${data.current_player + 1}</h2>`;
                }

                let stateHtml = '';
                data.players.forEach(player => {
                    stateHtml += `<div class="player-card">`;
                    stateHtml += `<h4>Player ${player.player_id + 1}`;
                    if (player.player_id === data.current_player && data.winner === null) {
                        stateHtml += ' <span class="text-blue-500">(Current)</span>';
                    }
                    stateHtml += '</h4>';
                    stateHtml += `<div class="flex justify-center items-start gap-4 w-full">`;

                    stateHtml += `<div class="flex flex-col items-center flex-1">`;
                    stateHtml += `<img src="assets/hand-${player.left.value}.png" alt="Left Hand Value ${player.left.value}">`;
                    stateHtml += `<p class="text-lg mt-2"><span class="${player.left.alive ? 'text-green-600' : 'text-red-600'}">${player.left.value} ${player.left.alive ? '(Alive)' : '(Dead)'}</span></p>`;

                    if (player.player_id === data.current_player && player.left.alive && data.winner === null) {
                        data.valid_moves.forEach((move, index) => {
                            if (move.type === 'attack' && move.from_hand === 'left') {
                                stateHtml += `<button class="move-button mt-2" onclick="makeMove(${index})">`;
                                stateHtml += `Attack P${move.to_player + 1}'s ${move.to_hand}`;
                                stateHtml += '</button>';
                            }
                        });
                    }
                    stateHtml += `</div>`; 

                    stateHtml += `<div class="flex flex-col items-center flex-1">`;
                    stateHtml += `<img src="assets/hand-${player.right.value}.png" alt="Right Hand Value ${player.right.value}">`;
                    stateHtml += `<p class="text-lg mt-2"><span class="${player.right.alive ? 'text-green-600' : 'text-red-600'}">${player.right.value} ${player.right.alive ? '(Alive)' : '(Dead)'}</span></p>`;

                    if (player.player_id === data.current_player && player.right.alive && data.winner === null) {
                        data.valid_moves.forEach((move, index) => {
                            if (move.type === 'attack' && move.from_hand === 'right') {
                                stateHtml += `<button class="move-button mt-2" onclick="makeMove(${index})">`;
                                stateHtml += `Attack P${move.to_player + 1}'s ${move.to_hand}`;
                                stateHtml += '</button>';
                            }
                        });
                    }
                    stateHtml += `</div>`; 
                    stateHtml += `</div>`; 

                    
                    if (player.player_id === data.current_player && data.winner === null) {
                        const currentPlayerSplits = data.valid_moves.filter(move => move.type === 'split');
                        if (currentPlayerSplits.length > 0) {
                            stateHtml += '<h4 class="text-xl font-semibold text-gray-700 mb-3 mt-4">Split Moves:</h4>';
                            currentPlayerSplits.forEach((move, index) => {
                                const originalIndex = data.valid_moves.findIndex(m => m === move);
                                stateHtml += `<button class="move-button" onclick="makeMove(${originalIndex})">`;
                                stateHtml += `Split: Move ${move.amount} from ${move.left_to_right ? 'Left to Right' : 'Right to Left'} (Result: L=${move.left_value}, R=${move.right_value})`;
                                stateHtml += '</button>';
                            });
                        }
                    }

                    stateHtml += `</div>`; 
                });
                document.getElementById('game-state').innerHTML = stateHtml;
            }

            async function makeMove(moveIndex) {
                try {
                    const movesResponse = await fetch('/game', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({action: 'get_moves'})
                    });
                    const movesData = await movesResponse.json();

                    const move = movesData.valid_moves[moveIndex];

                    const response = await fetch('/game', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            action: 'move',
                            move: move
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        updateGameDisplay(data);
                    } else {
                        displayMessage('Invalid Move', 'The move you attempted is not valid. Please choose another.', 'error');
                    }
                } catch (error) {
                    console.error('Error making move:', error);
                    displayMessage('Error', 'An error occurred while making the move. Please try again.', 'error');
                }
            }

            async function resetGame() {
                try {
                    const response = await fetch('/game', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({action: 'reset'})
                    });

                    const data = await response.json();

                    if (data.success) {
                        updateGameDisplay(data);
                    }
                } catch (error) {
                    console.error('Error resetting game:', error);
                    displayMessage('Error', 'An error occurred while resetting the game. Please try again.', 'error');
                }
            }

            async function getHint() {
                try {
                    const response = await fetch('/game', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({action: 'get_hint'})
                    });

                    const data = await response.json();

                    if (data.success && data.best_move) {
                        let hintHtml = '<div class="hint-box">';
                        hintHtml += '<h4 class="text-lg font-semibold mb-2">AI Hint:</h4>';
                        hintHtml += `<p><strong class="text-blue-800">Best Move:</strong> ${data.description}</p>`;
                        hintHtml += `<p><strong class="text-blue-800">Position Analysis:</strong> ${data.explanation}</p>`;
                        if (data.winning !== null) {
                            hintHtml += `<p><strong class="text-blue-800">Winning:</strong> ${data.winning ? 'Yes' : 'No'}</p>`;
                        }
                        hintHtml += '</div>';
                        document.getElementById('hint-display').innerHTML = hintHtml;
                    } else {
                        document.getElementById('hint-display').innerHTML = '<p class="text-center text-gray-600">No hint available.</p>';
                    }
                } catch (error) {
                    console.error('Error getting hint:', error);
                    displayMessage('Error', 'An error occurred while getting the hint. Please try again.', 'error');
                }
            }

            function displayMessage(title, message, type) {
                const messageBox = document.getElementById('message-box');
                const messageTitle = document.getElementById('message-box-title');
                const messageContent = document.getElementById('message-box-content');
                const messageCloseButton = document.getElementById('message-box-close');

                messageTitle.textContent = title;
                messageContent.textContent = message;

                messageBox.classList.remove('hidden');
                messageBox.classList.add('flex');

                if (type === 'error') {
                    messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                    messageTitle.classList.add('text-red-800');
                } else {
                    messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
                    messageTitle.classList.add('text-blue-800');
                }

                messageCloseButton.onclick = () => {
                    messageBox.classList.add('hidden');
                    messageBox.classList.remove('flex', 'bg-red-100', 'border-red-400', 'text-red-700', 'bg-blue-100', 'border-blue-400', 'text-blue-700');
                    messageTitle.classList.remove('text-red-800', 'text-blue-800');
                };
            }

            window.onload = function() {
                const initialData = {
                    game_id: "{{ game_id }}",
                    current_player: {{ current_player }},
                    winner: JSON.parse('{{ winner | tojson }}'),
                    players: JSON.parse('{{ players | tojson }}'),
                    valid_moves: JSON.parse('{{ valid_moves | tojson }}')
                };
                updateGameDisplay(initialData);
            };
        </script>
    </head>
    <body class="flex flex-col items-center p-5 bg-gray-100 min-h-screen">
        <h1 class="text-5xl font-extrabold text-blue-800 mb-8">CHOPPED</h1>

        <div id="current-player" class="w-full max-w-xl text-center mb-6"></div>

        <div class="game-info-section mb-6">
            <h3 class="text-2xl font-bold mb-4 text-center">Game State</h3>
            <div id="game-state" class="flex flex-col sm:flex-row justify-center items-center gap-4 player-cards-container"></div>
        </div>

        <div class="game-info-section mb-6">
            <h3 class="text-2xl font-bold mb-4 text-center">Controls</h3>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <button onclick="resetGame()" class="control-button reset">New Game</button>
                <button onclick="getHint()" class="control-button hint">AI Hint</button>
            </div>
        </div>

        <div id="hint-display" class="w-full max-w-xl"></div>

        <p class="mt-8 text-gray-500 text-sm">Game ID: <span class="font-mono">{{ game_id }}</span></p>

        <!-- Custom Message Box -->
        <div id="message-box" class="hidden fixed top-0 left-0 w-full h-full bg-gray-900 bg-opacity-50 items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm border-t-4 border-blue-500">
                <div class="flex justify-between items-center mb-4">
                    <h4 id="message-box-title" class="text-xl font-bold text-gray-800"></h4>
                    <button id="message-box-close" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">&times;</button>
                </div>
                <p id="message-box-content" class="text-gray-700 mb-4"></p>
                <div class="flex justify-end">
                    <button onclick="document.getElementById('message-box').classList.add('hidden');" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600">OK</button>
                </div>
            </div>
        </div>
    </body>
</html>

